name: APK Validation Testing

on:
  workflow_run:
    workflows: ["Build and Release APKs"]
    types:
      - completed
  workflow_dispatch:

env:
  NODE_ENV: test

jobs:
  test-apk-builds:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    strategy:
      matrix:
        build_type: [debug, release]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Download APK Artifacts
      id: download-apk
      run: |
        # Download APK from the build workflow
        echo "Downloading APK artifacts..."
        
        # Get the latest COMPLETED build run with APK artifacts
        # This handles cases where APK build succeeds but release step fails
        echo "Searching for latest completed build with APK artifacts..."
        
        LATEST_RUN=""
        for run_id in $(gh run list --workflow="Build and Release APKs" --limit=15 --status=completed --json=databaseId --jq='.[].databaseId'); do
          echo "Checking completed run $run_id for artifacts..."
          if gh api /repos/${{ github.repository }}/actions/runs/$run_id/artifacts --jq='.artifacts[] | select(.name | startswith("apk-${{ matrix.build_type }}")) | .name' | head -1 | grep -q "apk-"; then
            LATEST_RUN=$run_id
            echo "Found APK artifacts in run: $LATEST_RUN"
            break
          fi
        done
        
        if [ -z "$LATEST_RUN" ]; then
          echo "No build with APK artifacts found"
          exit 1
        fi
        
        # Get the artifact name pattern (includes build number)
        ARTIFACT_NAME=$(gh api /repos/${{ github.repository }}/actions/runs/$LATEST_RUN/artifacts --jq='.artifacts[] | select(.name | startswith("apk-${{ matrix.build_type }}")) | .name' | head -1)
        echo "Artifact name: $ARTIFACT_NAME"
        
        if [ -z "$ARTIFACT_NAME" ]; then
          echo "No artifact found for build type: ${{ matrix.build_type }}"
          exit 1
        fi
        
        # Download the specific build type APK
        gh run download $LATEST_RUN --name "$ARTIFACT_NAME" --dir ./apk-download
        
        # Find the APK file
        APK_FILE=$(find ./apk-download -name "*.apk" -type f | head -1)
        echo "Found APK: $APK_FILE"
        
        if [ -z "$APK_FILE" ]; then
          echo "No APK file found"
          exit 1
        fi
        
        # Convert to absolute path to avoid issues
        APK_ABSOLUTE=$(realpath "$APK_FILE")
        echo "Absolute APK path: $APK_ABSOLUTE"
        
        echo "apk_path=$APK_ABSOLUTE" >> $GITHUB_OUTPUT
        echo "apk_name=$(basename $APK_FILE)" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
        
    - name: AVD Cache
      uses: actions/cache@v4
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: avd-api-34-validation
        
    - name: Create AVD and generate snapshot for caching
      if: steps.avd-cache.outputs.cache-hit != 'true'
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        target: google_apis
        arch: x86_64
        profile: pixel_2
        force-avd-creation: false
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: false
        script: echo "Generated AVD snapshot for caching."
        
    - name: Run APK Validation Tests
      id: test-apk
      uses: reactivecircus/android-emulator-runner@v2
      env:
        APK_PATH: ${{ steps.download-apk.outputs.apk_path }}
        BUILD_TYPE: ${{ matrix.build_type }}
      with:
        api-level: 34
        target: google_apis
        arch: x86_64
        profile: pixel_2
        force-avd-creation: false
        emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        disable-animations: true
        script: |
          set -e
          
          echo "ðŸ” Testing $BUILD_TYPE APK: $APK_PATH"
          echo "ðŸ” APK_PATH variable: [$APK_PATH]"
          echo "ðŸ” File exists check: $([ -f "$APK_PATH" ] && echo "YES" || echo "NO")"
          
          # Validate APK path exists
          if [ -z "$APK_PATH" ]; then
            echo "âŒ APK_PATH is empty!"
            echo "Available APK files:"
            find . -name "*.apk" -type f
            exit 1
          fi
          
          if [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK file not found: $APK_PATH"
            echo "APK_PATH contents: [$APK_PATH]"
            echo "Current directory contents:"
            ls -la
            exit 1
          fi
          
          # Wait for emulator to be ready with better error handling
          echo "â³ Waiting for emulator to boot completely..."
          adb wait-for-device
          
          # Wait for system to be ready
          timeout 120 bash -c 'while [[ -z $(adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r") ]]; do 
            echo "Still booting..."
            sleep 2
          done'
          
          # Additional stability wait
          echo "â³ Ensuring emulator stability..."
          sleep 10
          
          # Unlock screen
          adb shell input keyevent 82 || true
          adb shell input keyevent 26 || true  # Power button
          adb shell input swipe 540 1200 540 600 || true  # Swipe up to unlock
          
          echo "âœ… Emulator ready for testing"
          
          # Clear any existing installs
          echo "ðŸ§¹ Clearing previous installations..."
          adb uninstall com.keeganmccallum.mobile_dev_studio || true
          
          # Create screenshots directory
          mkdir -p screenshots/$BUILD_TYPE
          
          # Take screenshot of clean state
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/00-clean-state.png
          
          # Install the APK with additional debugging
          echo "ðŸ“± Installing $BUILD_TYPE APK..."
          echo "APK file info:"
          ls -la "$APK_PATH"
          file "$APK_PATH" || true
          
          # Try installing with more permissive flags
          echo "Attempting APK installation..."
          if ! adb install -r -t -d "$APK_PATH"; then
            echo "âŒ Initial install failed, trying with force flag..."
            if ! adb install -r -t -d -g "$APK_PATH"; then
              echo "âŒ Install with grants failed, trying basic install..."
              adb install "$APK_PATH" || {
                echo "âŒ All install methods failed"
                echo "Device info:"
                adb shell getprop ro.build.version.sdk
                adb shell getprop ro.product.cpu.abi
                echo "Package manager logs:"
                adb logcat -d -s PackageManager:*,PackageInstaller:* | tail -20
                exit 1
              }
            fi
          fi
          
          # Verify installation
          if ! adb shell pm list packages | grep -q "com.keeganmccallum.mobile_dev_studio"; then
            echo "âŒ APK installation failed"
            exit 1
          fi
          echo "âœ… APK installed successfully"
          
          # Take screenshot after installation
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/01-post-install.png
          
          # Start extensive logging BEFORE launching the app
          echo "ðŸ” Starting comprehensive logging..."
          
          # Clear logcat buffer
          adb logcat -c
          
          # Start comprehensive logcat capture in background with crash logger support
          adb logcat -s \
            AndroidRuntime:V \
            System.err:V \
            ReactNativeJS:V \
            ReactNative:V \
            ExpoModulesCore:V \
            TermuxCore:V \
            Metro:V \
            Hermes:V \
            JSCruntime:V \
            chromium:V \
            CrashAnrDetector:V \
            ActivityManager:V \
            PackageManager:V \
            art:V \
            dalvikvm:V \
            libc:V \
            linker:V \
            DEBUG:V \
            CRASH_LOG:V \
            *:F \
            > screenshots/$BUILD_TYPE/full-launch-log.txt 2>&1 &
          
          LOGCAT_PID=$!
          echo "Started logcat capture (PID: $LOGCAT_PID)"
          
          # Launch the app and monitor for crashes
          echo "ðŸš€ Launching app..."
          adb shell am start -n com.keeganmccallum.mobile_dev_studio/.MainActivity
          
          # Wait longer and check multiple times
          echo "â³ Monitoring app launch (15 second timeout)..."
          
          for i in {1..15}; do
            sleep 1
            
            # Check if app is running
            APP_PID=$(adb shell ps | grep com.keeganmccallum.mobile_dev_studio | awk '{print $2}' || echo "")
            
            if [ -n "$APP_PID" ]; then
              echo "âœ… App is running (PID: $APP_PID, after ${i}s)"
              break
            fi
            
            echo "  Attempt $i/15: App not yet running..."
          done
          
          # Stop logcat capture
          kill $LOGCAT_PID 2>/dev/null || true
          sleep 1
          
          # Final check
          APP_PID=$(adb shell ps | grep com.keeganmccallum.mobile_dev_studio | awk '{print $2}' || echo "")
          if [ -z "$APP_PID" ]; then
            echo "âŒ App failed to start or crashed immediately"
            
            # Capture additional crash analysis
            echo "ðŸ“‹ Capturing comprehensive crash analysis..."
            
            # Get system info
            adb shell getprop > screenshots/$BUILD_TYPE/system-properties.txt
            
            # Get memory info
            adb shell cat /proc/meminfo > screenshots/$BUILD_TYPE/memory-info.txt
            
            # Get detailed logcat with all filters
            adb logcat -d > screenshots/$BUILD_TYPE/complete-logcat.txt
            
            # Get native crash dumps if any
            adb shell ls -la /data/tombstones/ > screenshots/$BUILD_TYPE/tombstones-list.txt 2>/dev/null || echo "No tombstones access" > screenshots/$BUILD_TYPE/tombstones-list.txt
            
            # Check dmesg for kernel messages
            adb shell dmesg | tail -100 > screenshots/$BUILD_TYPE/kernel-log.txt 2>/dev/null || echo "No dmesg access" > screenshots/$BUILD_TYPE/kernel-log.txt
            
            # Get package manager info
            adb shell pm list packages | grep mobile_dev_studio > screenshots/$BUILD_TYPE/package-info.txt
            adb shell pm dump com.keeganmccallum.mobile_dev_studio > screenshots/$BUILD_TYPE/package-dump.txt 2>/dev/null || echo "Package dump failed" > screenshots/$BUILD_TYPE/package-dump.txt
            
            # Take screenshot of current state
            adb exec-out screencap -p > screenshots/$BUILD_TYPE/02-launch-failed.png
            
            echo "ðŸ“‹ Comprehensive crash logs captured"
            echo "ðŸ“ Key files:"
            echo "  - full-launch-log.txt (filtered logs during launch)"
            echo "  - complete-logcat.txt (all system logs)"
            echo "  - system-properties.txt (device configuration)"
            echo "  - package-dump.txt (app installation details)"
            
            exit 1
          fi
          
          echo "âœ… App launched successfully (PID: $APP_PID)"
          
          # Take screenshot of successful launch
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/02-app-launched.png
          
          # Wait for app to fully load
          sleep 10
          
          # Take screenshot of loaded app
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/03-app-loaded.png
          
          # Test navigation between tabs
          echo "ðŸ§ª Testing tab navigation..."
          
          # Test Terminal tab (should be default)
          sleep 2
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/04-terminal-tab.png
          
          # Navigate to Preview tab
          adb shell input tap 540 850  # Approximate coordinates for Preview tab
          sleep 3
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/05-preview-tab.png
          
          # Navigate to Editor tab
          adb shell input tap 810 850  # Approximate coordinates for Editor tab
          sleep 3
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/06-editor-tab.png
          
          # Navigate to Termux Test tab
          adb shell input tap 1080 850  # Approximate coordinates for Termux tab
          sleep 3
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/07-termux-test-tab.png
          
          # Test Termux functionality
          echo "ðŸ”§ Testing Termux integration..."
          
          # Test Create Session button - more specific coordinates for Termux Demo tab
          adb shell input tap 540 400  # Create Session button in Termux Demo
          sleep 3
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/08-create-session-test.png
          
          # Test Execute Command buttons (try multiple command buttons)
          echo "Testing pwd command..."
          adb shell input tap 540 450  # pwd command button
          sleep 2
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/09-execute-pwd-test.png
          
          echo "Testing ls command..."
          adb shell input tap 540 500  # ls command button  
          sleep 2
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/10-execute-ls-test.png
          
          echo "Testing echo command..."
          adb shell input tap 540 550  # echo command button
          sleep 2
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/11-execute-echo-test.png
          
          # Test output area for content
          echo "Checking if Termux output appears..."
          adb shell dumpsys window | grep -i "output\|terminal\|session" > screenshots/$BUILD_TYPE/termux-window-dump.txt || true
          
          # Check if app is still running (no crashes during testing)
          APP_PID_AFTER=$(adb shell ps | grep com.keeganmccallum.mobile_dev_studio | awk '{print $2}' || echo "")
          if [ -z "$APP_PID_AFTER" ]; then
            echo "âŒ App crashed during testing"
            
            # Capture logcat for debugging
            adb logcat -d -s AndroidRuntime:E,System.err:E > screenshots/$BUILD_TYPE/test-crash-log.txt
            adb exec-out screencap -p > screenshots/$BUILD_TYPE/10-crashed-during-test.png
            
            exit 1
          fi
          
          echo "âœ… App remained stable throughout testing"
          
          # Final screenshot
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/12-final-state.png
          
          # Capture app logs
          adb logcat -d -s ReactNativeJS:* > screenshots/$BUILD_TYPE/app-logs.txt || true
          
          # Test app backgrounding and foregrounding
          echo "ðŸ“± Testing app lifecycle..."
          adb shell input keyevent 3  # Home button
          sleep 2
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/13-backgrounded.png
          
          # Bring app back to foreground
          adb shell am start -n com.keeganmccallum.mobile_dev_studio/.MainActivity
          sleep 3
          adb exec-out screencap -p > screenshots/$BUILD_TYPE/14-foregrounded.png
          
          # Final stability check
          APP_PID_FINAL=$(adb shell ps | grep com.keeganmccallum.mobile_dev_studio | awk '{print $2}' || echo "")
          if [ -z "$APP_PID_FINAL" ]; then
            echo "âŒ App crashed during lifecycle test"
            exit 1
          fi
          
          echo "ðŸŽ‰ $BUILD_TYPE APK validation completed successfully!"
          echo "âœ… No crashes detected"
          echo "âœ… App launches properly"
          echo "âœ… Navigation works"
          echo "âœ… Termux integration responds"
          echo "âœ… App lifecycle works"
          
    - name: Upload Test Screenshots and Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: apk-validation-${{ matrix.build_type }}-debug-artifacts
        path: screenshots/${{ matrix.build_type }}/
        retention-days: 30
        
    - name: Create Test Report
      if: always()
      run: |
        mkdir -p test-reports
        
        BUILD_TYPE="${{ matrix.build_type }}"
        APK_NAME="${{ steps.download-apk.outputs.apk_name }}"
        
        cat > test-reports/validation-report-$BUILD_TYPE.md << EOF
        # APK Validation Report - $BUILD_TYPE Build
        
        **APK:** \`$APK_NAME\`
        **Build Type:** $BUILD_TYPE
        **Test Date:** $(date -u)
        **Test Result:** ${{ job.status }}
        
        ## Test Results
        
        - ${{ steps.test-apk.outcome == 'success' && 'âœ…' || 'âŒ' }} APK Installation: ${{ steps.test-apk.outcome == 'success' && 'Success' || 'Failed' }}
        - ${{ steps.test-apk.outcome == 'success' && 'âœ…' || 'âŒ' }} App Launch: ${{ steps.test-apk.outcome == 'success' && 'Success' || 'Failed' }}
        - ${{ steps.test-apk.outcome == 'success' && 'âœ…' || 'âŒ' }} No Immediate Crashes: ${{ steps.test-apk.outcome == 'success' && 'Success' || 'Failed' }}
        - ${{ steps.test-apk.outcome == 'success' && 'âœ…' || 'âŒ' }} Tab Navigation: ${{ steps.test-apk.outcome == 'success' && 'Success' || 'Failed' }}
        - ${{ steps.test-apk.outcome == 'success' && 'âœ…' || 'âŒ' }} Termux Integration: ${{ steps.test-apk.outcome == 'success' && 'Success' || 'Failed' }}
        - ${{ steps.test-apk.outcome == 'success' && 'âœ…' || 'âŒ' }} App Lifecycle: ${{ steps.test-apk.outcome == 'success' && 'Success' || 'Failed' }}
        
        ## Screenshots
        
        All test screenshots have been captured and uploaded as artifacts.
        
        ## Logs
        
        App logs and any crash logs have been captured for analysis.
        EOF
        
    - name: Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: apk-validation-${{ matrix.build_type }}-report
        path: test-reports/
        retention-days: 30
        
    - name: Post Test Results
      if: always()
      uses: actions/github-script@v7
      with:
        script: |
          const buildType = '${{ matrix.build_type }}';
          const apkName = '${{ steps.download-apk.outputs.apk_name }}';
          const testResult = '${{ job.status }}';
          const runId = context.runId;
          
          const statusEmoji = testResult === 'success' ? 'âœ…' : 'âŒ';
          const statusText = testResult === 'success' ? 'PASSED' : 'FAILED';
          
          const comment = `## ${statusEmoji} APK Validation Results - ${buildType.toUpperCase()}
          
          **APK:** \`${apkName}\`  
          **Test Status:** ${statusText}  
          **Run ID:** ${runId}
          
          ### Test Coverage
          - ${statusEmoji} APK Installation
          - ${statusEmoji} App Launch (No Crashes)
          - ${statusEmoji} Tab Navigation
          - ${statusEmoji} Termux Integration Response
          - ${statusEmoji} App Lifecycle (Background/Foreground)
          
          ðŸ“¸ [View Screenshots](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}/artifacts)
          ðŸ“‹ [Download Test Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}/artifacts)
          `;
          
          // Create a gist with the test results for easy sharing
          try {
            const gist = await github.rest.gists.create({
              description: `APK Validation Results - ${buildType} - ${new Date().toISOString()}`,
              public: false,
              files: {
                [`apk-validation-${buildType}.md`]: {
                  content: comment
                }
              }
            });
            
            console.log(`Test results gist created: ${gist.data.html_url}`);
          } catch (error) {
            console.log('Failed to create gist:', error.message);
          }